---
title: "Fat tissue"
author: "Haipeng Sun"
date: "7/25/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## library
```{r message=FALSE, warning=FALSE, include=FALSE}
library(grid)
library(gridExtra)
library(gtable)
library(ggrepel)
library(rlist)
library(ggpubr)
library(readxl)
library(rstatix)
library(patchwork)
library(tidyverse)
```

## load data
```{r}
path_rec = "~/Dropbox/Rutgers/20220722_IFNH_CSR_new/"
load(file = paste0(path_rec,"data/general_data.Rdata"))
load(file = paste0(path_rec,"data/BW_responder.RData"))
```

## fat
### load fat PCR result
```{r}
BAT_file = paste0(path_rec,"data/ExperimentRecords/Result_from_Harini/BAT qPCR_New spls_11112021.xlsx")
iWAT_file = paste0(path_rec,"data/ExperimentRecords/Result_from_Harini/iWAT qPCR_New spls_11112021.xlsx")

df <- list()
for (ff in c("BAT","iWAT")){
  for (gene in c("UCP1","Cidea","Pgc 1a","Prdm 16", "Dio2","Sirt 1")){
    a <- read_excel(get(paste0(ff, "_file")), sheet = paste0(ff, "_", gene), range = "B2:J28")
    a <-  a %>% filter(!is.na(Gene)) %>% 
      transmute(FamilyID = `Animal Number`, BirthMode = str_remove(`Animal Number`,"\\d+"),
                Gene, Ct = CT, `18 s`, Delta_Ct = `Delta CT`, DD_Ct = `ddCt relative to WT`,
                FC = `Fold Change`, Tissue = ff)
    df <- list.append(df, a)
  }
}

df2 <- do.call(rbind, df) %>% 
  filter(!is.na(FC))

df_sum <-  df2 %>% group_by(Tissue, Gene, BirthMode) %>% 
  summarise(FC_mean = mean(FC), FC_sd = sd(FC), N = n()) %>% ungroup() %>% 
  mutate(FC_se = FC_sd / sqrt(N))
  

norm_test <- df2 %>% group_by(Tissue, Gene) %>% 
  shapiro_test(FC)

stat.test <- df2 %>% group_by(Tissue, Gene) %>% 
  wilcox_test(FC ~ BirthMode) %>% 
  adjust_pvalue(method = "fdr") %>% 
  add_significance("p.adj") %>% 
  add_xy_position(x = "BirthMode", scales = "free", fun = "mean_sd")

```

### plot
```{r}
temp_out = paste0(path_rec,"output/fat/")

g <- ggplot(df2, aes(Gene, FC, color = BirthMode)) + 
  geom_point(position = position_dodge(width = 0.9)) + 
  geom_col(data = df_sum, aes(Gene, FC, color = BirthMode, fill = BirthMode),
           position = position_dodge(), alpha = 0.5) +
  facet_grid(Tissue ~ ., scales = "free_y")

g_list <- list()

for (ff in c("BAT","iWAT")){
  for (gene in c("UCP1","Cidea","Pgc 1a","Prdm 16", "Dio2","Sirt 1")){
    wdat <- df2 %>% filter(Tissue == ff, Gene == gene)
    wdat_sum <- df_sum %>% filter(Tissue == ff, Gene == gene) 
    wstat.test <- stat.test %>% filter(Tissue == ff, Gene == gene)
    g_list[[ff]][[gene]]  <- ggplot(wdat, aes(BirthMode, FC, color = BirthMode)) + 
      geom_point() + 
      geom_col(data = wdat_sum, aes(BirthMode, FC_mean, fill = BirthMode), 
               alpha = 0.5, width = 0.3) + 
      geom_errorbar(data = wdat_sum, aes(BirthMode, FC_mean, ymin = FC_mean - FC_se, ymax = FC_mean + FC_se),
                    width = 0.1) +
      stat_pvalue_manual(wstat.test, label = "p.adj.signif", tip.length = 0, hide.ns = T, size = 12/.pt) + 
      scale_y_continuous(expand = c(0, 0), limits = c(0, max(wdat$FC)*1.05)) +
      labs(x = "", y = "Relative expression\n(Normalized to 18S RNA)", title = gene) + 
      theme_classic() + theme(aspect.ratio = 1,
                              panel.background = element_rect(fill = NA),
                              plot.title = element_text(size=14,color="black",face='bold',hjust=0.5),
                              axis.title.y = element_text(size=12,color="black",face='bold'),
                              axis.text.x = element_text(size=12,color="black",face='bold'),
                              axis.text.y = element_text(size=12,color="black",face='bold'),
                              legend.text = element_text(size=12,color="black",face='bold'),
                              legend.title = element_text(size=12,color="black",face='bold')) 
  }
}

for (ff in c("BAT","iWAT")){
  p0 <- g_list[[ff]][["Cidea"]]
  for (gene in c("Dio2","Pgc 1a","Prdm 16","Sirt 1","UCP1")){
    p0 <- p0 + g_list[[ff]][[gene]]
  }
  p0 <- p0 + plot_layout(guides = "collect", ncol = 6) + 
    plot_annotation(title = "", tag_levels = 'a') & theme(plot.tag = element_text(size = 12, face = "bold"), 
                                                          legend.position = "right")
  ggsave(filename = paste0(temp_out,ff, "_browning_marker_by_birthmode_QPCR.pdf"), device = cairo_pdf, 
         plot = p0, width = 15, height = 4, units = "in", dpi = 300)
  
}

```

## CLAMS
### load data
```{r}
CLAMS_file = paste0(path_rec,"data/ExperimentRecords/Result_from_Troy/DB IFNH CLAMS Analysis.xlsx")
Mapping_file = paste0(path_rec,"data/ExperimentRecords/Result_from_Troy/BehaviorAnimalMetadata-20190124-JW.xlsx")

dat <- lapply(excel_sheets(CLAMS_file),function(tt){
  a <- read_excel(CLAMS_file, sheet = tt, range = "A3:Y42", col_names = F)
  names(a) <- c("MouseID", c(0:23))
  a <- a %>% mutate(MouseID = str_to_upper(MouseID)) %>% 
    mutate(MouseID = ifelse(MouseID == "FO59.P8", "F059.P8", MouseID))
  aa <- a %>% pivot_longer(cols = -MouseID, values_to = "Value", names_to = "Time") %>% 
    filter(!is.na(Value)) %>% 
    mutate(Test = tt)
  aa
}) %>% do.call(rbind,.) 

map <- read_excel(Mapping_file) 
dat <- dat %>% 
  left_join(map, by = "MouseID") %>% 
  mutate(Time = as.integer(Time)) %>% 
  mutate(Day_or_Night = ifelse(Time>6&Time<19, "Day","Night"))

df_sum <-  dat %>% group_by(Time, Test, BirthMode) %>% 
  summarise(Value_mean = mean(Value), Value_sd = sd(Value), N = n()) %>% ungroup() %>% 
  mutate(Value_se = Value_sd / sqrt(N))
  
norm_test <- dat %>% group_by(Time, Test) %>% 
  shapiro_test(Value)

# norm_test %>% mutate(P2 = round(p, digits = 3)) %>% mutate(sig = ifelse(P2>0.05, "n","y")) %>% count(Test, sig) %>% pivot_wider(Test, names_from = sig, values_from = n)

stat.test1 <- dat %>% group_by(Time, Test, Sex) %>% 
  t_test(Value ~ BirthMode) %>% 
  adjust_pvalue(method = "BH") %>% 
  add_significance("p") %>% 
  add_xy_position(x = "BirthMode", scales = "free", fun = "mean_sd")




```

### plot















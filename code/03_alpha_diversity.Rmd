---
title: "Alpha diversity"
author: "Haipeng Sun"
date: "7/14/2022"
output: html_document
---

## library
```{r setup, message=FALSE, warning=FALSE}
library(knitr)
library(phyloseq)
library(purrr)
library(furrr)
library(picante)
library(vegan)
library(MASS)
library(tidyverse)
```

## load data
```{r}
load(file = "../data/BW_and_phylo.RData")
```

## rarefy to the depth
```{r}
ft = t((subset_samples(phylo_decomtan, !Sample_or_Blank))@otu_table@.Data)
ft_list = ft %>% 
  as.data.frame() %>% rownames_to_column(var = "SampleID") %>%
  pivot_longer(-SampleID, names_to = "ASV", values_to = "count") %>%
  filter(count > 0) %>% split(., .$SampleID)

asv_count_df = ft_list[[2]]
phylotree = phylo_decomtan@phy_tree

alpha_diversity_bootstrap = function(asv_count_df, phylotree, depth, n=100){
  alpha_diversity_sample = function(asv_count_df, phylotree, seed, depth){
      all_asv_count = rep(asv_count_df$ASV, asv_count_df$count)
      set.seed(seed)
      boot_asv = sample(all_asv_count, size = depth, replace = T)
      boot_dat = table(boot_asv) %>% as.matrix() 
      colnames(boot_dat) = "count"
      faith = pd(t(boot_dat), phylotree, include.root = F)$PD
      observed = nrow(boot_dat)
      shannon = diversity(boot_dat, index = "shannon")
      evenness = shannon/log(observed)
      data.frame(faith = faith, observed = observed, shannon = shannon, evenness = evenness)
  }
  if (sum(asv_count_df$count) < depth){
    c(faith = NA, observed = NA, shannon = NA, evenness = NA)
  }else{
    map_dfr(c(1:n), alpha_diversity_sample, 
                      asv_count_df = asv_count_df, phylotree = phylotree, 
                      depth = depth,
            .id = NULL) %>% colMeans()
    }
}

plan(multisession)
system.time(aa <- future_map_dfr(ft_list, alpha_diversity_bootstrap, 
                                phylotree = phylotree, depth = depth, n = 1000, 
                                .id = "SampleID", .progress = F,
                                .options = furrr_options(seed=NULL)))
alpha_boot = aa %>% filter(!is.na(faith)) %>%
  select(SampleID, Faith_PD=faith, Observed_ASVs=observed, Shannon_Index=shannon, Pielou_evenness=evenness)

#alpha from a rarefied table
a1 = pd(t(phylo_decomtan_rf@otu_table@.Data), phylo_decomtan_rf@phy_tree, include.root = F)
a2 = estimate_richness(phylo_decomtan_rf, measures="Shannon")
alpha_rftb = merge(a1, a2, by=0)
names(alpha_rftb) = c("SampleID","Faith_PD", "Observed_ASVs","Shannon_Index")
alpha_rftb$Pielou_evenness = alpha_rftb$Shannon_Index/log(alpha_rftb$Observed_ASVs)

#rarefy table or bootstrap have similar results
alpha_test = inner_join(alpha_rftb, alpha_boot, by = "SampleID")
alpha_test %>% mutate(faith_diff = Faith_PD.x - Faith_PD.y,
                      observed_diff = Observed_ASVs.x - Observed_ASVs.y,
                      shannon_diff = Shannon_Index.x - Shannon_Index.y,
                      evenness_diff = Pielou_evenness.x - Pielou_evenness.y) %>%
  select(SampleID, ends_with("diff")) %>% 
  pivot_longer(-SampleID, names_to = "Metrics", values_to = "difference") %>% 
  mutate(Metrics = str_remove(Metrics,"_diff")) %>% 
  ggplot(aes(y = difference)) + 
    geom_boxplot() + 
    facet_wrap(~ Metrics, nrow = 2, scales = "free_y")

alpha_test %>% pivot_longer(-SampleID, names_to = c("Metrics", "Method"), names_sep = "\\.") %>% 
  mutate(Method = ifelse(Method == "x", "Rarefy_table", "Bootstrap")) %>% 
  pivot_wider(c(SampleID, Metrics), names_from = Method, values_from = value) %>% 
  ggplot(aes(x = Rarefy_table, y = Bootstrap)) + 
    geom_point() + 
    geom_smooth(method = "lm") + 
    facet_wrap(~ Metrics, nrow = 2, scales = "free")
```

## save data
```{r}
#use bootstrapped alpha for further study
alpha = alpha_boot
#save(alpha, file = "../data/alpha.RData")
```

## load data
```{r}
load(file = "../data/alpha.RData")
temp_out = "../result/alpha/"
dat_alpha <- left_join(alpha, meta_all, by = "SampleID")

theme_custom <- theme_bw() + theme(panel.background = element_rect(fill = NA), 
                                   text = element_text(face = 'bold', color = "black", size = 14))
```

## alpha expolore mom vaginal
```{r}
g <- dat_alpha %>% mutate(grp = case_when(TimePoint == "Week3" ~ "pups week3",
                                      TimePoint == "Week6" ~ "pups week6",
                                      TimePoint == "Week9-14" ~ "pups week9-14",
                                      TimePoint == "Week18" ~ "pups week18",
                                      BodySite == "Vaginal" ~ "moms at birth")) %>%
  mutate(grp = factor(grp, levels = c("moms at birth","pups week3",
                                       "pups week6","pups week9-14","pups week18"),
                       ordered = TRUE)) %>% 
  select(SampleID,grp,BodySite,Faith_PD,Observed_ASVs,Shannon_Index,Pielou_evenness) %>% 
  pivot_longer(c(Faith_PD:Pielou_evenness), names_to = "Metrics") %>%
  ggplot(aes(x=grp, y=value)) + 
  geom_boxplot(aes(color=BodySite, fill=BodySite), alpha = 0.3, outlier.alpha = 0) + 
  geom_point(aes(color=BodySite), position = position_dodge2(width = 0.2)) + 
  scale_color_manual(values = c("Feces"="#7fc97f","Vaginal"="#beaed4"), 
                     aesthetics = c("color","fill")) + 
  labs(x="",y="", tittle="") + 
  facet_wrap(~ Metrics, nrow = 2, scales = "free_y") + 
  theme_bw() + theme(aspect.ratio = 0.8,
                     panel.background = element_rect(fill = NA),
                     strip.text = element_text(size=12,color="black",face='bold'),
                     axis.title = element_text(size=12,color="black",face='bold'),
                     axis.text = element_text(size=12,color="black",face='bold'),
                     axis.text.x = element_text(size=12,color="black",face='bold',angle=90),
                     axis.text.y = element_text(size=12,color="black",face='bold'),
                     legend.text = element_text(size=12,color="black",face='bold'),
                     legend.title = element_text(size=12,color="black",face='bold'),
                     title = element_text(size=12,color="black",face='bold'))

ggsave(filename = paste0(temp_out,"vaginal_fecal_by_timepoint.pdf"), device = cairo_pdf, 
         plot = g, width = 7, height = 5, units = "in", dpi = 300)
```

## alpha effect of birthmode
```{r}
dat_alpha_pup <- dat_alpha %>% filter(Generation=="F1")
metric <- names(alpha)[2:5]

fit.null <- lm(as.formula(paste0(metric[4], " ~ 1")), data=dat_alpha_pup) 
fit.full <- lm(as.formula(paste0(metric[4], " ~ BirthMode + Sex + TimePointInWeeks")),
               data=dat_alpha_pup)
regforward.out <- stepAIC(fit.null, scope = ~ BirthMode + Sex + TimePointInWeeks,
                          direction = "forward", trace = 10)





```



















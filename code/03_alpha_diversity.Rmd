---
title: "Alpha diversity"
author: "Haipeng Sun"
date: "7/14/2022"
output: html_document
---

## library

```{r setup, message=FALSE, warning=FALSE}
library(knitr)
library(phyloseq)
library(purrr)
library(furrr)
library(picante)
library(vegan)
library(MASS)
library(tidyverse)
```

## rarefy to the depth (only run one time)

```{r}
load(file = "../data/BW_and_phylo.RData")

ft = t((subset_samples(phylo_decomtan, !Sample_or_Blank))@otu_table@.Data)
ft_list = ft %>% 
  as.data.frame() %>% rownames_to_column(var = "SampleID") %>%
  pivot_longer(-SampleID, names_to = "ASV", values_to = "count") %>%
  filter(count > 0) %>% split(., .$SampleID)

asv_count_df = ft_list[[2]]
phylotree = phylo_decomtan@phy_tree

alpha_diversity_bootstrap = function(asv_count_df, phylotree, depth, n=100){
  alpha_diversity_sample = function(asv_count_df, phylotree, seed, depth){
      all_asv_count = rep(asv_count_df$ASV, asv_count_df$count)
      set.seed(seed)
      boot_asv = sample(all_asv_count, size = depth, replace = T)
      boot_dat = table(boot_asv) %>% as.matrix() 
      colnames(boot_dat) = "count"
      faith = pd(t(boot_dat), phylotree, include.root = F)$PD
      observed = nrow(boot_dat)
      shannon = diversity(boot_dat, index = "shannon")
      evenness = shannon/log(observed)
      data.frame(faith = faith, observed = observed, shannon = shannon, evenness = evenness)
  }
  if (sum(asv_count_df$count) < depth){
    c(faith = NA, observed = NA, shannon = NA, evenness = NA)
  }else{
    map_dfr(c(1:n), alpha_diversity_sample, 
                      asv_count_df = asv_count_df, phylotree = phylotree, 
                      depth = depth,
            .id = NULL) %>% colMeans()
    }
}

plan(multisession)
system.time(aa <- future_map_dfr(ft_list, alpha_diversity_bootstrap, 
                                phylotree = phylotree, depth = depth, n = 1000, 
                                .id = "SampleID", .progress = F,
                                .options = furrr_options(seed=NULL)))
alpha_boot = aa %>% filter(!is.na(faith)) %>%
  select(SampleID, Faith_PD=faith, Observed_ASVs=observed, Shannon_Index=shannon, Pielou_evenness=evenness)

#alpha from a rarefied table
a1 = pd(t(phylo_decomtan_rf@otu_table@.Data), phylo_decomtan_rf@phy_tree, include.root = F)
a2 = estimate_richness(phylo_decomtan_rf, measures="Shannon")
alpha_rftb = merge(a1, a2, by=0)
names(alpha_rftb) = c("SampleID","Faith_PD", "Observed_ASVs","Shannon_Index")
alpha_rftb$Pielou_evenness = alpha_rftb$Shannon_Index/log(alpha_rftb$Observed_ASVs)

#rarefy table or bootstrap have similar results
alpha_test = inner_join(alpha_rftb, alpha_boot, by = "SampleID")
alpha_test %>% mutate(faith_diff = Faith_PD.x - Faith_PD.y,
                      observed_diff = Observed_ASVs.x - Observed_ASVs.y,
                      shannon_diff = Shannon_Index.x - Shannon_Index.y,
                      evenness_diff = Pielou_evenness.x - Pielou_evenness.y) %>%
  select(SampleID, ends_with("diff")) %>% 
  pivot_longer(-SampleID, names_to = "Metrics", values_to = "difference") %>% 
  mutate(Metrics = str_remove(Metrics,"_diff")) %>% 
  ggplot(aes(y = difference)) + 
    geom_boxplot() + 
    facet_wrap(~ Metrics, nrow = 2, scales = "free_y")

alpha_test %>% pivot_longer(-SampleID, names_to = c("Metrics", "Method"), names_sep = "\\.") %>% 
  mutate(Method = ifelse(Method == "x", "Rarefy_table", "Bootstrap")) %>% 
  pivot_wider(c(SampleID, Metrics), names_from = Method, values_from = value) %>% 
  ggplot(aes(x = Rarefy_table, y = Bootstrap)) + 
    geom_point() + 
    geom_smooth(method = "lm") + 
    facet_wrap(~ Metrics, nrow = 2, scales = "free")

#use bootstrapped alpha for further study
alpha = alpha_boot
#save(alpha, file = "../data/alpha.RData")
```

## load data

```{r}
load(file = "../data/BW_and_phylo.RData")
load(file = "../data/alpha.RData")
temp_out = "../result/alpha/"
dat_alpha <- left_join(alpha, meta_all, by = "SampleID")
```

## alpha expolore mom vaginal

```{r}
g <- dat_alpha %>% mutate(grp = case_when(TimePoint == "Week3" ~ "week3",
                                      TimePoint == "Week6" ~ "week6",
                                      TimePoint == "Week9-14" ~ "week9-14",
                                      TimePoint == "Week18" ~ "week18",
                                      BodySite == "Vaginal" ~ "at birth")) %>%
  mutate(grp = factor(grp, levels = c("at birth","week3","week6","week9-14","week18"),
                       ordered = TRUE)) %>% 
  select(SampleID,grp,BodySite,Faith_PD,Observed_ASVs,Shannon_Index,Pielou_evenness) %>% 
  pivot_longer(c(Faith_PD:Pielou_evenness), names_to = "Metrics") %>%
  ggplot(aes(x=grp, y=value)) + 
  geom_boxplot(aes(color=BodySite, fill=BodySite), alpha = 0.3, outlier.alpha = 0) + 
  geom_point(aes(color=BodySite), position = position_dodge2(width = 0.2)) + 
  scale_color_manual(values = c("Feces"="#7fc97f","Vaginal"="#beaed4"), 
                     name = "",
                     labels = c("pups fecal", "moms vaginal"),
                     aesthetics = c("color","fill")) + 
  labs(x="",y="", tittle="") + 
  facet_wrap(~ Metrics, nrow = 2, scales = "free_y") + 
  theme_bw() + theme(aspect.ratio = 0.8,
                     panel.background = element_rect(fill = NA),
                     strip.text = element_text(size=12,color="black",face='bold'),
                     axis.title = element_text(size=12,color="black",face='bold'),
                     axis.text = element_text(size=12,color="black",face='bold'),
                     axis.text.x = element_text(size=12,color="black",face='bold',angle=90),
                     axis.text.y = element_text(size=12,color="black",face='bold'),
                     legend.text = element_text(size=12,color="black",face='bold'),
                     legend.title = element_text(size=12,color="black",face='bold'),
                     title = element_text(size=12,color="black",face='bold'))
ggsave(filename = paste0(temp_out,"vaginal_fecal_by_timepoint.pdf"), device = cairo_pdf, 
         plot = g, width = 7, height = 5, units = "in", dpi = 300)
```

## effect of birthmode on pups

### linear model

```{r}
linear_model <- function(data, x, y) {
  #input data, respond variable y, variable formula
  require(effectsize)
  fit = lm(as.formula(paste0(y, " ~ ", x)), data = data)
  anova_fit <- anova(fit)
  sum_fit <- summary(fit)
  effect_fit <- effectsize(anova_fit, "omega")
  res_coef <- sum_fit$coefficients %>% as.data.frame() %>% 
    rownames_to_column(var="variable") %>% mutate(Metrics = y)
  res_anova <- right_join(anova_fit %>% as.data.frame() %>% rownames_to_column(var = "Parameter"),
                          effect_fit %>% as.data.frame(), by = "Parameter") %>% 
    mutate(Metrics = y)
  res <- list(res_coef, res_anova)
  names(res) = c("coef","anova")
  res  
}

dat_alpha_pup <- dat_alpha %>% filter(Generation=="F1")
metric <- names(alpha)[2:5]
###TimePointInWeeks
all_res <- map(metric, linear_model, data = dat_alpha_pup %>% 
                 mutate(TimePointInWeeks = as.character(TimePointInWeeks)), 
               x = "BirthMode + Sex + TimePointInWeeks")
write.csv(rbind(all_res[[1]]$coef,all_res[[2]]$coef,all_res[[3]]$coef,all_res[[4]]$coef),
          file = paste0(temp_out,"lm_coef_TimePointInWeeks_res.csv"), row.names = FALSE)
write.csv(rbind(all_res[[1]]$anova,all_res[[2]]$anova,all_res[[3]]$anova,all_res[[4]]$anova),
          file = paste0(temp_out,"lm_anova_TimePointInWeeks_res.csv"), row.names = FALSE)
###TimePoint
all_res <-lapply(metric, function(y){
  linear_model(data = dat_alpha_pup, y = y,
                  x = "BirthMode + Sex + TimePoint")
})
write.csv(rbind(all_res[[1]]$coef,all_res[[2]]$coef,all_res[[3]]$coef,all_res[[4]]$coef),
          file = paste0(temp_out,"lm_coef_TimePoint_res.csv"), row.names = FALSE)
write.csv(rbind(all_res[[1]]$anova,all_res[[2]]$anova,all_res[[3]]$anova,all_res[[4]]$anova),
          file = paste0(temp_out,"lm_anova_TimePoint_res.csv"), row.names = FALSE)
```

### compare birthmode

```{r}
comp_kw_aov = function(wdat, x, y){
  #input data, respond variable y, categorize variable x
  require(agricolae)
  ktest1 = kruskal(wdat[y], wdat[x], alpha = 0.05, p.adj="none", group=T, main = "wdat", console=FALSE)
  out_g_1 = ktest1$groups %>% rownames_to_column(var = "Var") %>% select(Var, groups) %>% rename(KW_group = groups)
  ktest2 = kruskal(wdat[y], wdat[x], alpha = 0.05, p.adj="none", group=F, main = "wdat", console=FALSE)
  out_c_1 = ktest2$comparison %>% rownames_to_column(var = "comp") %>% select(comp, pvalue) %>% rename(KW_pvalue = pvalue)
  fit = aov(as.formula(paste0(y, "~", x)), wdat)
  tukey1 = HSD.test(fit, x, group = T)
  out_g_2 = tukey1$groups %>% rownames_to_column(var = "Var") %>% select(Var, groups) %>% rename(aov_group = groups)
  tukey2 = HSD.test(fit, x, group = F)
  out_c_2 = tukey2$comparison %>% rownames_to_column(var = "comp") %>% select(comp, pvalue) %>% rename(aov_pvalue = pvalue)
  out_g = merge(out_g_1, out_g_2,by = 1)
  out_c = merge(out_c_1, out_c_2,by = 1)
  res = list(out_g, out_c)
  names(res) = c("grp","comp")
  res
}

dat_alpha_pup <- dat_alpha %>% filter(Generation=="F1")
metric <- names(alpha)[2:5]

###TimePointInWeeks
lst_df <- expand.grid(dat_alpha_pup$Sex %>% unique(), 
                       dat_alpha_pup$TimePointInWeeks %>% unique(), 
                       metric, stringsAsFactors = F)
names(lst_df) <- c("Sex", "TimePointInWeeks", "Metrics")

plan(multisession)
all_res <- future_map_dfr(1:nrow(lst_df), function(n){
  wdat <- dat_alpha_pup %>% filter(Sex == lst_df[n,"Sex"], 
                                  TimePointInWeeks == lst_df[n,"TimePointInWeeks"])
  res <- comp_kw_aov(wdat = wdat, x = "BirthMode", y = lst_df[n,"Metrics"])
  res$grp <- cbind(res$grp, lst_df[n,],row.names = NULL)
  res$comp <- cbind(res$comp, lst_df[n,],row.names = NULL)
  res
})
all_res$comp$KW_padj <- p.adjust(all_res$comp$KW_pvalue, method = "fdr")
all_res$comp$aov_padj <- p.adjust(all_res$comp$aov_pvalue, method = "fdr")
write.csv(all_res$grp, row.names = FALSE,
          file = paste0(temp_out,"kw_aov_grp_birthmode_by_Sex_TimePointInWeeks.csv"))
write.csv(all_res$comp, row.names = FALSE,
          file = paste0(temp_out,"kw_aov_comp_birthmode_by_Sex_TimePointInWeeks.csv"))

###TimePoint
lst_df <- expand.grid(dat_alpha_pup$Sex %>% unique(), 
                       dat_alpha_pup$TimePoint %>% unique(), 
                       metric, stringsAsFactors = F)
names(lst_df) <- c("Sex", "TimePoint", "Metrics")

plan(multisession)
all_res <- future_map_dfr(1:nrow(lst_df), function(n){
  wdat <- dat_alpha_pup %>% filter(Sex == lst_df[n,"Sex"], 
                                  TimePoint == lst_df[n,"TimePoint"])
  res <- comp_kw_aov(wdat = wdat, x = "BirthMode", y = lst_df[n,"Metrics"])
  res$grp <- cbind(res$grp, lst_df[n,],row.names = NULL)
  res$comp <- cbind(res$comp, lst_df[n,],row.names = NULL)
  res
})
all_res$comp$KW_padj <- p.adjust(all_res$comp$KW_pvalue, method = "fdr")
all_res$comp$aov_padj <- p.adjust(all_res$comp$aov_pvalue, method = "fdr")
write.csv(all_res$grp, row.names = FALSE,
          file = paste0(temp_out,"kw_aov_grp_birthmode_by_Sex_TimePoint.csv"))
write.csv(all_res$comp, row.names = FALSE,
          file = paste0(temp_out,"kw_aov_comp_birthmode_by_Sex_TimePoint.csv"))
```

### plot alpha by birthmod over time
```{r}
library(ggpubr)
dat <- dat_alpha %>% filter(Generation=="F1") %>% 
  select(SampleID,Faith_PD,Observed_ASVs,Shannon_Index,Pielou_evenness, 
         BodySite,TimePointInWeeks,TimePoint,Sex, BirthMode) %>% 
  pivot_longer(c(Faith_PD:Pielou_evenness), names_to = "Metrics")
  
metric <- dat$Metrics %>% unique()
#by birthmod
g <- ggplot(data = dat,
           aes(x = TimePoint, y = value)) + 
  geom_boxplot(aes(color = BirthMode, fill = BirthMode),
               alpha = 0.3, outlier.alpha = 0) + 
  geom_point(aes(color = BirthMode), alpha = 0.7, size = 1,
             position = position_dodge2(width = 0.6)) + 
  stat_compare_means(aes(group = BirthMode), hide.ns = T, label =  "p.signif") +
  scale_color_manual(values = BirthMode_color, 
                     name = "Birth Mode",
                     aesthetics = c("color","fill")) + 
  labs(x="",y="", tittle="") + 
  facet_wrap(~ Metrics, nrow = 2, scales = "free_y") + 
  theme_bw() + theme(panel.background = element_rect(fill = NA),
                     strip.text = element_text(size=10,color="black",face='bold'),
                     axis.title = element_text(size=10,color="black",face='bold'),
                     axis.text = element_text(size=10,color="black",face='bold'),
                     axis.text.x = element_text(size=10,color="black",face='bold',angle=0),
                     axis.text.y = element_text(size=10,color="black",face='bold'),
                     legend.text = element_text(size=10,color="black",face='bold'),
                     legend.title = element_text(size=10,color="black",face='bold'),
                     title = element_text(size=10,color="black",face='bold'))
ggsave(filename = paste0(temp_out,"pup_by_birthmode_by_timepoint.pdf"), device = cairo_pdf, 
         plot = g, width = 7, height = 6, units = "in", dpi = 300)
#by Sex
g <- ggplot(data = dat,
           aes(x = TimePoint, y = value)) + 
  geom_boxplot(aes(color = Sex, fill = Sex),
               alpha = 0.3, outlier.alpha = 0) + 
  geom_point(aes(color = Sex), alpha = 0.7,size = 1,
             position = position_dodge2(width = 0.6)) + 
  stat_compare_means(aes(group = Sex), hide.ns = T, label =  "p.signif") +
  scale_color_manual(values = c("M"="#1b9e77","F"="#d95f02"), 
                     name = "Sex",
                     labels = c("Male","Female"),
                     aesthetics = c("color","fill")) + 
  labs(x="",y="", tittle="") + 
  facet_wrap(~ Metrics, nrow = 2, scales = "free_y") + 
  theme_bw() + theme(panel.background = element_rect(fill = NA),
                     strip.text = element_text(size=10,color="black",face='bold'),
                     axis.title = element_text(size=10,color="black",face='bold'),
                     axis.text = element_text(size=10,color="black",face='bold'),
                     axis.text.x = element_text(size=10,color="black",face='bold',angle=0),
                     axis.text.y = element_text(size=10,color="black",face='bold'),
                     legend.text = element_text(size=10,color="black",face='bold'),
                     legend.title = element_text(size=10,color="black",face='bold'),
                     title = element_text(size=10,color="black",face='bold'))
ggsave(filename = paste0(temp_out,"pup_by_sex_by_timepoint.pdf"), device = cairo_pdf, 
         plot = g, width = 7, height = 6, units = "in", dpi = 300)
```
















---
title: "Alpha diversity"
author: "Haipeng Sun"
date: "7/14/2022"
output: html_document
---

## library
```{r setup, message=FALSE, warning=FALSE}
library(knitr)
library(phyloseq)
library(purrr)
library(furrr)
library(picante)
library(vegan)
library(tidyverse)
```

## load data
```{r}
load(file = "../data/BW_and_phylo.RData")
temp_out = "../result/alpha/"
```

## rarefy to the depth
```{r}
ft = t((subset_samples(phylo_decomtan, !Sample_or_Blank))@otu_table@.Data)
ft_list = ft %>% 
  as.data.frame() %>% rownames_to_column(var = "SampleID") %>%
  pivot_longer(-SampleID, names_to = "ASV", values_to = "count") %>%
  filter(count > 0) %>% split(., .$SampleID)

asv_count_df = ft_list[[2]]
phylotree = phylo_decomtan@phy_tree

alpha_diversity_bootstrap = function(asv_count_df, phylotree, depth, n=100){
  alpha_diversity_sample = function(asv_count_df, phylotree, seed, depth){
      all_asv_count = rep(asv_count_df$ASV, asv_count_df$count)
      set.seed(seed)
      boot_asv = sample(all_asv_count, size = depth, replace = T)
      boot_dat = table(boot_asv) %>% as.matrix() 
      colnames(boot_dat) = "count"
      faith = pd(t(boot_dat), phylotree, include.root = F)$PD
      observed = nrow(boot_dat)
      shannon = diversity(boot_dat, index = "shannon")
      evenness = shannon/log(observed)
      data.frame(faith = faith, observed = observed, shannon = shannon, evenness = evenness)
  }
  if (sum(asv_count_df$count) < depth){
    c(faith = NA, observed = NA, shannon = NA, evenness = NA)
  }else{
    map_dfr(c(1:n), alpha_diversity_sample, 
                      asv_count_df = asv_count_df, phylotree = phylotree, 
                      depth = depth,
            .id = NULL) %>% colMeans()
    }
}

plan(multisession)
system.time(aa <- future_map_dfr(ft_list, alpha_diversity_bootstrap, 
                                phylotree = phylotree, depth = depth, n = 1000, 
                                .id = "SampleID", .progress = F,
                                .options = furrr_options(seed=NULL)))
alpha_boot = aa %>% filter(!is.na(faith)) %>%
  select(SampleID, Faith_PD=faith, Observed_ASVs=observed, Shannon_Index=shannon, Pielou_evenness=evenness)

#alpha from a rarefied table
a1 = pd(t(phylo_decomtan_rf@otu_table@.Data), phylo_decomtan_rf@phy_tree, include.root = F)
a2 = estimate_richness(phylo_decomtan_rf, measures="Shannon")
alpha_rftb = merge(a1, a2, by=0)
names(alpha_rftb) = c("SampleID","Faith_PD", "Observed_ASVs","Shannon_Index")
alpha_rftb$Pielou_evenness = alpha_rftb$Shannon_Index/log(alpha_rftb$Observed_ASVs)

#rarefy table or bootstrap have similar results
alpha_test = inner_join(alpha_rftb, alpha_boot, by = "SampleID")
alpha_test %>% mutate(faith_diff = Faith_PD.x - Faith_PD.y,
                      observed_diff = Observed_ASVs.x - Observed_ASVs.y,
                      shannon_diff = Shannon_Index.x - Shannon_Index.y,
                      evenness_diff = Pielou_evenness.x - Pielou_evenness.y) %>%
  select(SampleID, ends_with("diff")) %>% 
  pivot_longer(-SampleID, names_to = "Metrics", values_to = "difference") %>% 
  mutate(Metrics = str_remove(Metrics,"_diff")) %>% 
  ggplot(aes(y = difference)) + 
    geom_boxplot() + 
    facet_wrap(~ Metrics, nrow = 2, scales = "free_y")

alpha_test %>% pivot_longer(-SampleID, names_to = c("Metrics", "Method"), names_sep = "\\.") %>% 
  mutate(Method = ifelse(Method == "x", "Rarefy_table", "Bootstrap")) %>% 
  pivot_wider(c(SampleID, Metrics), names_from = Method, values_from = value) %>% 
  ggplot(aes(x = Rarefy_table, y = Bootstrap)) + 
    geom_point() + 
    geom_smooth(method = "lm") + 
    facet_wrap(~ Metrics, nrow = 2, scales = "free")
```

## save data
```{r}
#use bootstrapped alpha for further study
alpha = alpha_boot
#save(alpha, file = "../data/alpha.RData")
#load(file = "../data/alpha.RData")
```



















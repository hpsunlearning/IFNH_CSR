---
title: "Data process"
author: "Haipeng Sun"
date: "7/13/2022"
output: html_document
---

## library
```{r setup, message=FALSE, warning=FALSE}
library(readxl)
library(phyloseq)
library(qiime2R)
library(Hmisc)
library(vegan)
library(tidyverse)
```

## settings
```{r}
# set path
path_rec <- "~/Dropbox/IFNH CSR/ExperimentRecords/"
data_path <- "~/Dropbox/rutgers/20220722_IFNH_CSR_new/data/"
temp_out <- "~/Dropbox/rutgers/20220722_IFNH_CSR_new/output/"
metafile <- "MasterMetadata-CS-SW-20220623-hs.xlsx"
# set colors, labs and so on
BirthMode_color <- c("VF"="#377EB8", "CSR"="#4DAF4A", "CS"="#E41A1C")
Sex_labs <- c("F" = "Female", "M" = "Male")
Sex_color <- c("F"="#e9a3c9", "M"="#a1d76a")
responder_color <- c("Responder"="#d95f0e", "Nonresponder"="gray50")
Age_color <- c("Week3"="#fdbe85", "Week6"="#fd8d3c", "Week9-14"="#e6550d", "Week18"="#a63603")
BW_status_color <- c("Overweight"="#7570b3", "Normal"="#b3cde3","Underweight"="#66a61e")
```

## Body weight data
### Body weight summary
```{r}
BW <- read_excel(paste0(path_rec, metafile), sheet = "BodyWeightRecords", range = "A1:T2009") %>% filter(!is.na(Weight_g))
BW$BirthMode <- factor(BW$BirthMode, levels = c("CS", "CSR","VF"))
BW <- BW %>% mutate(covid = case_when(Batch %in% c("Batch9","Batch10") ~ "Post covid",
                                     TRUE ~ "Before covid"))

BW_sum <- BW %>% group_by(TimePoint_Weeks, BirthMode, Sex) %>% 
  summarise(N = n(),
            N_batch = unique(Batch) %>% length,
            N_family = unique(FamilyNo) %>% length(),
            Mean = mean(Weight_g), 
            SE = sd(Weight_g)/sqrt(N),
            SD = sd(Weight_g),
            boot.lo = smean.cl.boot(Weight_g, conf.int = .95, B = 1000, na.rm = T, reps = F)[2],
            boot.hi = smean.cl.boot(Weight_g, conf.int = .95, B = 1000, na.rm = T, reps = F)[3]) %>%
  ungroup()

BW_sum %>% mutate(Count = paste0(N, "(", N_family, ")")) %>% 
  select(BirthMode, Sex, TimePoint_Weeks, Count) %>% 
  spread(key = TimePoint_Weeks, value = Count) 
```

### Body Weight gain relative to week 3
```{r}
BWgain <- BW %>% filter(TimePoint_Weeks > 2) %>% 
  arrange(MouseID, TimePoint_Weeks) %>% 
  group_by(MouseID) %>% 
    mutate(BW_gain = Weight_g - Weight_g[1], 
           BW_gain_percent = BW_gain/Weight_g[1],
           N = n()) %>% 
    filter(TimePoint_Weeks > 3, N > 3) %>% 
  ungroup()

BWgain_sum <- BWgain %>% group_by(TimePoint_Weeks, BirthMode, Sex) %>% 
  summarise(N = n(), 
            N_batch = unique(Batch) %>% length, 
            N_family = unique(FamilyNo) %>% length(), 
            Mean = mean(BW_gain), 
            boot.lo = smean.cl.boot(BW_gain, conf.int = .95, B = 1000, na.rm = T, reps = F)[2],
            boot.hi = smean.cl.boot(BW_gain, conf.int = .95, B = 1000, na.rm = T, reps = F)[3],
            boot_p.lo = smean.cl.boot(BW_gain_percent, conf.int = .95, B = 1000, na.rm = T, reps = F)[2],
            boot_p.hi = smean.cl.boot(BW_gain_percent, conf.int = .95, B = 1000, na.rm = T, reps = F)[3],
            Mean_p = mean(BW_gain_percent)) %>% ungroup()

BWgain_sum %>% mutate(Count = paste0(N, "(", N_family, ")")) %>% 
  select(BirthMode, Sex, TimePoint_Weeks, Count) %>% 
  spread(key = TimePoint_Weeks, value = Count)
```

## LitterSize
```{r}
a <- BW %>% select(FamilyID, LitterSize_Born, LitterSize_InProject) %>% unique()
cor(a$LitterSize_Born,a$LitterSize_InProject)
rm(a)
```

## Gestational days 
```{r}
FR <- read_excel(paste0(path_rec, metafile), sheet = "FamilyRecords", na = c("","NA"), range = "A1:V145")
a <- table(FR$BirthMode,FR$GestationalDay_Birth)
aa <- a %>% as.matrix.data.frame() %>% as.data.frame()
colnames(aa) <- colnames(a)
rownames(aa) <- rownames(a)
a
rm(FR, a, aa)
```

## Fecal 16S
### import into phyloseq
```{r}
phylo_all <- qza_to_phyloseq(features = "~/Dropbox/rutgers/20220722_IFNH_CSR_new/04_dada/table_csr.qza",
                         taxonomy = "~/Dropbox/rutgers/20220722_IFNH_CSR_new/05_taxa/taxonomy_all_silva138.qza",
                         tree =  "~/Dropbox/rutgers/20220722_IFNH_CSR_new/04_dada/rooted_tree_all.qza",
                         metadata = "~/Dropbox/rutgers/20220722_IFNH_CSR_new/meta_csr.txt")
```

### metadata
```{r}
meta_all <- phylo_all@sam_data@.Data %>% as.data.frame()
names(meta_all) <- phylo_all@sam_data@names
meta_all$SampleID <- phylo_all@sam_data@row.names
meta_all$Seq_count <- sample_sums(phylo_all)
meta_all <- meta_all %>% mutate(Age_group = case_when(TimePointInWeeks == 3 ~ "Week3",
                                          TimePointInWeeks == 6 ~ "Week6",
                                          TimePointInWeeks == 18 ~ "Week18",
                                          TimePointInWeeks %in% c(9,11,12,14) ~ "Week9-14"))
meta_all$Age_group <- factor(meta_all$Age_group, levels = c("Week3","Week6","Week9-14","Week18"),ordered = T)
meta_all$Sample_or_Blank <- ifelse(is.na(meta_all$MouseID),T,F)

sample_data(phylo_all) <- sample_data(meta_all %>% column_to_rownames(var = "SampleID"))

meta_all %>% filter(Generation == "F1") %>% 
  group_by(BirthMode, TimePointInWeeks, Sex) %>% 
  summarise(N = n(),
            N_family = unique(FamilyNo) %>% length(),
            Count = paste0(N, "(", N_family, ")")) %>%
  ungroup() %>% 
  dplyr::select(BirthMode, Sex, TimePointInWeeks, Count) %>% 
  tidyr::spread(key = TimePointInWeeks, value = Count) 
  
meta_all %>% filter(Generation == "F1") %>% 
  group_by(BirthMode, Age_group, Sex) %>% 
  summarise(N = n(),
            N_family = unique(FamilyNo) %>% length(),
            Count = paste0(N, "(", N_family, ")")) %>%
  ungroup() %>% 
  dplyr::select(BirthMode, Sex, Age_group, Count) %>% 
  tidyr::spread(key = Age_group, value = Count)
```

### taxa
```{r}
taxa = tax_table(phylo_all@tax_table) %>% as.matrix() %>% as.data.frame() %>% rownames_to_column(var = "id")
taxa = taxa %>% mutate(ASV = str_c("asv_", 1:nrow(taxa)),
                       Kingdom = str_replace_na(Kingdom,""), Kingdom = str_replace(Kingdom,"d__","k_"),
                       Phylum = str_replace_na(Phylum,""), Phylum = str_c("p_",Phylum),
                       Class = str_replace_na(Class,""), Class = str_c("c_",Class),
                       Order = str_replace_na(Order,""), Order = str_c("o_",Order),
                       Family = str_replace_na(Family,""), Family = str_c("f_",Family),
                       Genus = str_replace_na(Genus,""), Genus = str_c("g_",Genus),
                       Species = str_replace_na(Species,""), Species = str_c("s_",Species)
                      )
```

### decontam
```{r }
library(decontam)
contamdf = isContaminant(phylo_all, method="combined", conc="PCR_Conc",neg="Sample_or_Blank" )
contam_id = contamdf %>% filter(contaminant) %>% rownames()
phylo_decontam = prune_taxa(!(taxa_names(phylo_all) %in% contam_id), phylo_all)
taxa %>% filter(id %in% contam_id)
rm(contamdf, contam_id)
```

### filter unwanted taxa
```{r}
remove_id <- c(taxa %>% filter(str_detect(Kingdom, "Unassigned")) %>% pull(id),
               taxa %>% filter(str_detect(Order, "Chloroplast")|str_detect(Family, "Chloroplast")) %>% pull(id),
               taxa %>% filter(str_detect(Order, "Mitochondria")|str_detect(Family, "Mitochondria")) %>% pull(id))
phylo_decontam_clean <- prune_taxa(!(taxa_names(phylo_decontam) %in% remove_id), phylo_decontam)
rm(remove_id)
mean(sample_sums(phylo_all))
mean(sample_sums(phylo_decontam))
mean(sample_sums(phylo_decontam_clean))
cbind(sample_sums(phylo_all), sample_sums(phylo_decontam),sample_sums(phylo_decontam_clean)) %>% 
  as.data.frame() %>% 
  rename(original=V1, decontamed=V2, decontam_cleaned=V3) %>%
  merge(., meta_all, by.x=0, by.y="SampleID") %>% 
  transmute(SampleID=Row.names, DNA_Conc, MouseID, FamilyID, 
            SampleType, TimePointInWeeks, BirthMode, 
            original, decontamed, decontam_cleaned) %>% 
  arrange(decontam_cleaned) %>% head(n = 20)
```

### rarefy depth
```{r }
ft <- otu_table(phylo_decontam_clean) %>% as.matrix() %>% as.data.frame() %>% t()
coverage_stat <- ft %>% as.data.frame() %>% 
  rownames_to_column(var = "SampleID") %>% 
  pivot_longer(cols = -SampleID, names_to = "id", values_to = "count") %>% 
  filter(count > 0) %>% group_by(SampleID) %>%
  summarise(n_seqs = sum(count),
            n_singles = sum(count==1),
            goods = 100*(1 - n_singles/n_seqs)) %>% 
  ungroup()

coverage_stat %>% ggplot(aes(x=n_seqs)) + 
  geom_histogram() + 
  labs(x="Depth", title = "Histograph of sequencing depth") 

coverage_stat %>% arrange(n_seqs) %>%
  ggplot(aes(x=1:nrow(.), y=n_seqs))+ 
  geom_point() + 
  labs(x = "", y="Depth", title = "Sequencing depth low to high")

coverage_stat %>%ggplot(aes(x=n_seqs, y=goods)) + 
  geom_point() + 
  geom_hline(yintercept = 99, color = "red") + 
  labs(x = "Depth", y = "Goods coverage", title = "Goods coverage")

rarecurve_data = rarecurve(ft, step = 50, tidy = T)
```

### set depth to 2992
```{r }
depth = 2992
coverage_stat %>%ggplot(aes(x=n_seqs, y=goods)) + 
  geom_point() + 
  geom_hline(yintercept = 99, color = "red") + 
  geom_label(data = data.frame(n_seqs = c(60000,8000), 
                               goods = c(98, 80), 
                               label = c("99 Goods coverage", "Rarefy depth")), 
             aes(label = label)) + 
  geom_vline(xintercept = depth, color = "black") + 
  labs(x = "Depth", y = "Goods coverage", title = "Goods coverage")


rarecurve_data %>% ggplot(aes(x=Sample, y=Species, group=Site)) + 
  geom_line(alpha = 0.3) + 
  geom_vline(xintercept = depth, color = "black") + 
  geom_label(data = data.frame(Sample = c(2000), 
                               Species = c(300), 
                               Site = "",
                               label = c("Rarefy depth")), 
             aes(label = label)) + 
  labs(x = "Depth", y = "Number of ASVs") + 
  coord_cartesian(xlim = c(0,5000)) 

set.seed(3)
phylo_decontam_clean_rf = rarefy_even_depth(phylo_decontam_clean, 
                                      sample.size = depth, 
                                      rngseed = 3, 
                                      replace = F)
rm(ft, coverage_stat)
```

## save data
```{r eval=FALSE, include=TRUE}
#save.image(file = "../data/BW_and_phylo.RData")
#load(file = "../data/BW_and_phylo.RData")
#save.image(file = paste0(data_path,"BW_and_phylo.RData"))
#load(file = paste0(data_path,"BW_and_phylo.RData"))
```


















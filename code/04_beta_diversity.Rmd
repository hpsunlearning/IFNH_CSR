---
title: "Beta diversity"
author: "Haipeng Sun"
date: "7/14/2022"
output: html_document
---

## library
```{r setup, message=FALSE, warning=FALSE}
library(knitr)
library(phyloseq)
library(usedist)
library(purrr)
library(furrr)
library(vegan)
library(data.table)
library(tidyverse)
```

## load data
```{r}
load(file = "../data/BW_and_phylo.RData")
temp_out = "../result/beta/"
```

## rarefy to the depth 
### unifrac functions
```{r}
dist_to_long_tbl <- function(dist_matrix){
  dist_matrix %>% as.matrix() %>% as_tibble(rownames = "Sample1") %>%
      pivot_longer(-Sample1) %>% 
      rename(Sample2 = name, Distance = value) %>% 
      filter(Sample2 <= Sample1)
} 

cal_unifrac_dist_long <- function(rarified_psdata){
  ptree <- rarified_psdata@phy_tree
  ptree_new <- ape::multi2di(ptree, random = F)
  rarified_psdata@phy_tree <- ptree_new
  DM_uu <- UniFrac(rarified_psdata, weighted = FALSE)  
  DM_wu <- UniFrac(rarified_psdata, weighted = TRUE)
  dist_tbl_uu <- dist_to_long_tbl(DM_uu)
  dist_tbl_wu <- dist_to_long_tbl(DM_wu)
  dist_tbl <- inner_join(dist_tbl_uu, dist_tbl_wu, 
                         by = c("Sample1", "Sample2")) %>% 
    pivot_longer(cols = starts_with("Distance"),
                 names_to = "Metric") %>% 
    mutate(Metric = ifelse(Metric=="Distance.x", "uu","wu"))
  dist_tbl
  #dist_uu = pivot_to_numeric_matrix(dist_tbl %>% filter(Metric == "uu"), Sample1, Sample2, value) %>% as.dist()
  #dist_wu = pivot_to_numeric_matrix(dist_tbl %>% filter(Metric == "wu"), Sample1, Sample2, value) %>% as.dist()
}

cal_unifrac_dist_rarefy <- function(psdata, depth, rngseed){
    if(max(sample_sums(psdata)) < depth) return()
    psdata <- prune_samples(sample_sums(psdata) >= depth, psdata)
    rarified_psdata <- rarefy_even_depth(psdata, depth, replace = TRUE, verbose = FALSE, rngseed = rngseed)
    dist_tbl <- cal_unifrac_dist_long(rarified_psdata)
}

cal_unifrac_dist_rarefy_chunk <- function(psdata, depth, int_list){

  res_long <- future_map_dfr(int_list, cal_unifrac_dist_rarefy, 
                                psdata = psdata, depth = depth, 
                                .id = "N", .progress = F,
                                .options = furrr_options(seed=NULL))
  res_dt <- as.data.table(res_long %>% select(Sample1, Sample2, Metric, value))
  res <- res_dt[, .(value = mean(value)), by = .(Sample1, Sample2, Metric)]
}

cal_unifrac_dist_rarefy_bootstrap <- function(psdata, depth, n, block_size = 100){
  if (n <= block_size){
    res <- cal_unifrac_dist_rarefy_chunk(psdata = psdata, depth = depth, c(1:n))
  }else{
    lst <- split(c(1:n), cut(1:n, breaks = ceiling(n/block_size)))
    res_lst <- lapply(lst, function(x){
      res_l <- cal_unifrac_dist_rarefy_chunk(psdata = psdata, depth = depth, x)
      res_l$value <- res_l$value * length(x)
      res_l
    })
    res_bind <- do.call(rbind, res_lst)
    res <- res_bind[, .(value = sum(value)/n), by = .(Sample1, Sample2, Metric)]
  }
  res
}

### for test
#aa <- future_map_dfr(c(1:5), cal_unifrac_dist_rarefy, 
#                                psdata = phylo_decomtan, depth = depth, 
#                                .id = "N", .progress = F,
#                                .options = furrr_options(seed=NULL))
#print(object.size(aa), units = "auto")
#17.8 Mb
#aa_2 <- future_map_dfr(c(3:8), cal_unifrac_dist_rarefy, 
#                                psdata = phylo_decomtan, depth = depth, 
#                                .id = "N", .progress = F,
#                                .options = furrr_options(seed=NULL))
## test seed
#seed == 5
#inner_join(aa %>% filter(N==5) %>% select(-N), 
#           aa_2 %>% filter(N==3) %>% select(-N), 
#           by = c("Sample1", "Sample2", "Metric")) %>% 
#  mutate(eq = ifelse(value.x == value.y, "Y", "N")) %>% pull(eq) %>% table()
#seed == 3
#inner_join(aa %>% filter(N==3) %>% select(-N), 
#           aa_2 %>% filter(N==1) %>% select(-N), 
#           by = c("Sample1", "Sample2", "Metric")) %>% 
#  mutate(eq = ifelse(value.x == value.y, "Y", "N")) %>% pull(eq) %>% table()
# test data.table vs tible
#system.time(bb <- aa %>% select(Sample1, Sample2, Metric, value) %>% 
#      group_by(Sample1, Sample2, Metric) %>% summarise(value = mean(value)) %>% ungroup())
#   user  system elapsed 
#  0.887   0.007   0.914 
#system.time(aadt <- as.data.table(aa %>% select(Sample1, Sample2, Metric, value)))
#   user  system elapsed 
#  0.010   0.002   0.012
#system.time(bbdt <- aadt[, .(value = mean(value)), by = .(Sample1, Sample2, Metric)])
#   user  system elapsed 
#  0.068   0.002   0.070
#res <- inner_join(bb, bbdt, by = c("Sample1","Sample2","Metric")) %>%  
#  mutate(eq = ifelse(value.x == value.y, "Y","N"),
#         eq_digi6 = ifelse(round(value.x,6) == round(value.y,6), "Y","N"),
#         eq_digi3 = ifelse(round(value.x,3) == round(value.y,3), "Y","N"))
#table(res$eq)[1] == nrow(res)
#table(res$eq_digi6)[1] == nrow(res)
#data.table run faster, maybe because it use single precision not dbl?
# test chunck/block calculation
#system.time(aa_3 <- cal_unifrac_dist_rarefy_chunk(psdata = phylo_decomtan, depth = depth,int_list = c(1:11)))
#   user  system elapsed 
#  8.462   0.416 133.130 
#system.time(aa_4 <- cal_unifrac_dist_rarefy_bootstrap(psdata = phylo_decomtan, depth = depth, n = 11, block_size = 3))
#   user  system elapsed 
#  9.647   0.543 173.396 
#system.time(aa_5 <- cal_unifrac_dist_rarefy_bootstrap(psdata = phylo_decomtan, depth = depth, n = 11, block_size = 15))
#   user  system elapsed 
#  7.985   0.397 135.142 
#res <- inner_join(aa_5, aa_4, by = c("Sample1","Sample2","Metric")) %>%  
#  mutate(eq = ifelse(value.x == value.y, "Y","N"),
#         eq_digi6 = ifelse(round(value.x,6) == round(value.y,6), "Y","N"),
#         eq_digi3 = ifelse(round(value.x,3) == round(value.y,3), "Y","N"))
#table(res$eq)[1] == nrow(res)
#table(res$eq_digi6)[1] == nrow(res)
#use no chunk run faster than in chunks

```

### calculate distance
```{r}
psdata <- subset_samples(phylo_decomtan, !Sample_or_Blank)

plan(multisession)  
system.time(unif_two <- cal_unifrac_dist_rarefy_bootstrap(psdata = psdata, depth = depth, 
                                                          n = 1000, block_size = 1000))
DM_uu <- pivot_to_numeric_matrix(unif_two %>% filter(Metric == "uu"), Sample1, Sample2, value) %>% as.dist()
DM_wu <- pivot_to_numeric_matrix(unif_two %>% filter(Metric == "wu"), Sample1, Sample2, value) %>% as.dist()

ft = t(psdata@otu_table@.Data)
system.time(DM_bray <- avgdist(ft,dmethod = "bray", sample = depth, iterations = 10))
system.time(DM_jaccard <- avgdist(ft,dmethod = "jaccard", sample = depth, iterations = 10))
```

## save data
```{r}
#save( ,file = "../data/beta.RData")
#load(file = "output/temp_16S.RData")
```

















